# Development Guide

Instructions for building MDGitView from source and contributing to the project.

## Prerequisites

- **macOS 14.0+**
- **Xcode** (full install, not just Command Line Tools)
- **Rust toolchain** (`rustup`)
- **XcodeGen** (`brew install xcodegen`)

## Quick start

```bash
# 1. Install Rust (if not already)
rustup toolchain install stable

# 2. Select Xcode
sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

# 3. Install XcodeGen
brew install xcodegen

# 4. Build and install to /Applications
./scripts/install.sh
```

The install script handles everything: builds the Rust FFI, generates the Xcode project, compiles the app, and installs it to `/Applications`.

## Manual build steps

If you prefer to build step by step:

```bash
# Build Rust FFI library
./scripts/build_rust.sh Debug

# Generate Xcode project
cd md-viewer-macos && xcodegen generate

# Open in Xcode
open MDGitView.xcodeproj
```

Then build and run the `MDGitView` scheme in Xcode.

## Project layout

```
md-engine/          Rust markdown rendering library
md-ffi/             Rust C ABI bridge for Swift integration
  include/          C header (md_ffi.h)
md-viewer-macos/    SwiftUI app + Quick Look extensions
  App/              Main app (ContentView, ViewerViewModel)
  Shared/           Shared code (MarkdownRenderService, RustMarkdownFFI, RenderModels)
  PreviewExtension/ Quick Look preview extension
  ThumbnailExtension/ Quick Look thumbnail extension
  Resources/Assets/ CSS, JavaScript (mermaid, mathjax, viewer-shell)
  Config/           Info.plist files and entitlements
  Vendor/           Built Rust static library (generated by build)
scripts/            Build, install, notarize, release scripts
docs/               Security model, implementation notes
tests/fixtures/     Markdown test files
```

## Architecture

### Rendering pipeline

```
Markdown text
    ↓
md-engine (Rust)     — GFM parsing, HTML generation, sanitization, TOC, diagnostics
    ↓
md-ffi (C ABI)       — JSON in/out via md_render(), md_free_result(), md_last_error()
    ↓
RustMarkdownFFI.swift — Swift wrapper, JSON encode/decode
    ↓
MarkdownRenderService — Builds full HTML document with CSS + JS (mermaid, mathjax)
    ↓
WKWebView            — Renders HTML in app and Quick Look extension
```

### Quick Look extension

The Quick Look preview extension (`MarkdownPreviewExtension`) uses `QLPreviewingController` with a `WKWebView` to render a full-page interactive markdown preview. It reuses the same `MarkdownRenderService` and Rust FFI as the main app — same rendering quality, including Mermaid diagrams.

The preview injects a floating "Open in MDGitView" button that launches the main app via `NSWorkspace`.

### Targets

| Target | Type | Bundle ID |
|--------|------|-----------|
| MDGitView | Application | com.toni.mdgitview |
| MarkdownPreviewExtension | App Extension | com.toni.mdgitview.preview |
| MarkdownThumbnailExtension | App Extension | com.toni.mdgitview.thumbnail |

## Quick Look debugging

```bash
# Preview a file
qlmanage -p /path/to/file.md

# Generate thumbnail
qlmanage -t -s 512 -o /tmp /path/to/file.md

# Reset Quick Look cache
qlmanage -r
qlmanage -r cache

# Check registered extensions
pluginkit -mDvvv -p com.apple.quicklook.preview

# View extension logs
log stream --predicate 'subsystem == "com.apple.quicklook"' --level debug
```

## Release process

```bash
# Build release
./scripts/release.sh

# Notarize (requires Apple Developer account)
./scripts/notarize.sh
```

## Key files reference

| File | Purpose |
|------|---------|
| `md-viewer-macos/project.yml` | XcodeGen project definition |
| `md-viewer-macos/Shared/MarkdownRenderService.swift` | HTML document builder |
| `md-viewer-macos/Shared/RustMarkdownFFI.swift` | Swift-to-Rust FFI bridge |
| `md-viewer-macos/Shared/RenderModels.swift` | Data models (RenderOptions, RenderedPayload) |
| `md-viewer-macos/PreviewExtension/MarkdownPreviewViewController.swift` | Quick Look preview controller |
| `md-viewer-macos/Resources/Assets/github-markdown.css` | GitHub-style CSS |
| `md-viewer-macos/Resources/Assets/mermaid.min.js` | Mermaid diagram renderer |
| `md-engine/src/lib.rs` | Rust rendering engine |
| `md-ffi/src/lib.rs` | Rust FFI exports |

## License

MIT
